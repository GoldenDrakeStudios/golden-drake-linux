#!/usr/bin/env bash
# Copyright (C) 2020-2021 Golden Drake Studios
# Forked from the Anarchy installer, copyright (C) 2017 Dylan Schacht

. libgdl.sh
. /etc/gdl.conf
. /usr/share/gdl/lang/english.conf

start_menu() {
  # Only run if the start menu hasn't been run already
  if [ ! -f /root/.gdl_updated ]; then
    # Customize pacman.conf and add multilib
    sed -i 's/^#Color$/Color/' /etc/pacman.conf
    sed -i 's/^#TotalDownload$/TotalDownload/' /etc/pacman.conf
    sed -i 's/^#CheckSpace$/CheckSpace/' /etc/pacman.conf
    sed -i '/^#VerbosePkgLists$/ a ILoveCandy' /etc/pacman.conf
    sed -i '/\[multilib]$/ {
      N
      /Include/s/#//g}' /etc/pacman.conf
    dialog --clear --title " About Golden Drake Linux (GDL) " \
      --msgbox "\n${start_menu_msg}\n\n${start_menu_social}" 18 80
    # Ask the user what they want to do, default to updating gdl
    op_title="GDL"
    menu_choice="$(dialog --menu "What do you want to do?" 18 80 5 \
      "Update" "Update gdl and start the installation" \
      "Start" "Start the installation" \
      "Exit" "Drop into a shell (run 'gdl' to return)" 3>&1 1>&2 2>&3)"
    log "Start menu: chose to ${menu_choice}"
    case "${menu_choice}" in
    Update)
      # Update Arch packages and keyring
      check_connection
      log "Updating pacman keys"
      (
        pacman -Sy archlinux-keyring --noconfirm | log
        pacman-key --keyserver hkp://keyserver.ubuntu.com --init | log
        pacman-key --keyserver hkp://keyserver.ubuntu.com --populate archlinux \
          | log
        pacman-key --keyserver hkp://keyserver.ubuntu.com --refresh-keys | log
      ) &>/dev/null &
      pid=$! pri=0.3 \
        msg="\n${pacman_load}\n\n \Z1> \Z3pacman-key --refresh-keys\Zn" load
      touch /root/.gdl_updated
      ;;
    Start) ;;
    Exit) clear && exit ;;
    esac
  fi
}

init() {
  trap force_quit SIGINT # Execute trap when CTRL+C is pressed (SIGINT)
  gdl_directory='/usr/share/gdl'
  for library in /usr/lib/gdl/*; do
    . "${library}"
  done
  language
  . "${lang_file}"
  export reload=true
  systemctl start NetworkManager.service
}

install_arch_linux() {
  prepare_base
  graphics
  set_hostname
  set_user
  select_additional_software
  install_base
  configure_system
  add_user
  install_additional_software
  reboot_system
}

main() {
  if [ "$(id -u)" -ne 0 ]; then
    echo "Error: $0 requires root privileges"
    echo "  Use: sudo $0"
    exit 1
  fi
  set_keyboard_layout
  start_menu
  update_mirrors
  get_connection_info
  set_locale
  set_zone
  prepare_drives
  install_arch_linux
}

init
main
