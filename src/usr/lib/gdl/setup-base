#!/bin/bash

install_base() {
  op_title="${install_op_msg}"
  if [ -n "${lib}" ]; then
    BASE_PACKAGES+="libreoffice-fresh-${lib} "
  fi
  if ENABLE_BTRFS; then
    BASE_PACKAGES+="grub-btrfs "
  fi
  BASE_PACKAGES=$(tr <<<"${BASE_PACKAGES}" " " "\n" | sort | uniq | tr "\n" " ")
  clear
  dragonsay "Installing base packages..." | tee -a "${LOG_FILE}"
  pacman -Sy
  pacstrap /mnt ${BASE_PACKAGES} |& tee -a "${LOG_FILE}"
  if [ "$?" -eq "0" ]; then
    INSTALLED=true
    log "Completed base installation"
  else
    report_error
    clear
    dragonsay "${how_to_relaunch_installer}"
    exit 1
  fi
  genfstab -U -p /mnt >>/mnt/etc/fstab |& tee -a "${LOG_FILE}"
  log "Generated fstab"
  grub_config
  log "Configured grub"
}

prepare_base() {
  op_title="${install_op_msg}"
  BASE_PACKAGES+="${UCODE} "
  if "${WIFI_AVAILABLE}" ||
      (yesno "\n${wifi_option_msg}" "${yes}" "${no}" 1); then
    BASE_PACKAGES+="wireless_tools wpa_supplicant "
    log "Added wireless utilities"
  fi
  if "${BLUETOOTH_AVAILABLE}" &&
      (yesno "\n${bluetooth_msg}" "${yes}" "${no}" 1); then
    BASE_PACKAGES+="bluez bluez-utils pulseaudio-bluetooth "
    BLUETOOTH_ENABLED=true
    log "Added bluetooth support"
  fi
  if (yesno "\n${os_prober_msg}" "${yes}" "${no}" 1); then
    BASE_PACKAGES+="os-prober "
    log "Added os-prober"
  fi
  if "${UEFI}"; then
    BASE_PACKAGES+="efibootmgr "
    log "Added efibootmgr"
  fi
}
