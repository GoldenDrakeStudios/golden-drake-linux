#!/usr/bin/env bash

install_base() {
  op_title="${install_op_msg}"
  base_install=$(tr <<<"${base_install}" " " "\n" | sort | uniq | tr "\n" " ")
  pacman -Sy --print-format='%s' $(echo "${base_install}") | awk \
    '{s+=$1} END {print s/1024/1024}' >/tmp/size &
  pid=$! pri=0.6 msg="\n${pacman_load}\n\n \Z1> \Z3pacman -Sy\Zn" load
  download_size="$(</tmp/size)"
  rm /tmp/size
  export software_size
  software_size=$(sed <<<"${download_size}" 's/\(\..\)\(.*\)/\1 MiB/')
  cal_rate

  until "${INSTALLED}"; do
    if (yesno "\n${install_var}" "${install}" "${cancel}"); then
      log "Begin base install"
      base_install="$(pacman -Sqg base linux) ${base_install}"
      (
        pacstrap "${ARCH}" --overwrite $(echo "${base_install}")
        echo "$?" >/tmp/ex_status
      ) | log &
      pid=$! pri=$(echo "${down}" | sed 's/\..*$//') \
        msg="\n${install_load_var}" load_log
      genfstab -U -p "${ARCH}" >>"${ARCH}"/etc/fstab
      if [ "$(</tmp/ex_status)" -eq "0" ]; then
        INSTALLED=true
        log "Installed packages to system"
      else
        report_error
        exit 1
      fi
      grub_config
      log "Configured bootloader"
    else
      if (yesno "\n${exit_msg}" "${yes}" "${no}"); then
        unset base_install DE
        main_menu
      fi
    fi
  done
}

prepare_base() {
  op_title="${install_op_msg}"
  base_install="${default_packages} ${UCODE} "
  if "${wifi}" || (yesno "\n${wifi_option_msg}" "${yes}" "${no}" 1); then
    base_install+="wireless_tools wpa_supplicant "
    log "Added wireless utilities"
  fi
  if "${bluetooth}" && (yesno "\n${bluetooth_msg}" "${yes}" "${no}" 1); then
    base_install+="bluez bluez-utils pulseaudio-bluetooth "
    enable_bt=true
    log "Added bluetooth support"
  fi
  if (yesno "\n${os_prober_msg}" "${yes}" "${no}" 1); then
    base_install+="os-prober "
    log "Added os-prober"
  fi
  if "${enable_f2fs}"; then
    base_install+="f2fs-tools "
    log "Added f2fs-tools"
  fi
  if "${UEFI}"; then
    base_install+="efibootmgr "
    log "Added efibootmgr"
  fi
}
